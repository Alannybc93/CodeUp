# exercicios/views.py - VERSÃO COMPLETA CORRIGIDA
import time
from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.utils import timezone
from django.db.models import Count, Sum

# Importe os modelos CORRETAMENTE
from .models import Exercicio, RespostaAluno
# Modulo e Trilha estão em trilhas.models
try:
    from trilhas.models import Modulo, Trilha
    TRILHA_EXISTS = True
except ImportError:
    # Se não existir, crie placeholders
    TRILHA_EXISTS = False
    class Modulo:
        objects = None
    class Trilha:
        objects = None

# ============ VIEWS PRINCIPAIS ============

def index(request):
    """Lista todos os exercícios com filtros"""
    # Obter todos os exercícios
    exercicios = Exercicio.objects.all()
    
    # Tentar usar select_related se Trilha existir
    if TRILHA_EXISTS:
        exercicios = exercicios.select_related('modulo__trilha')
    else:
        exercicios = exercicios.select_related('modulo')
    
    # Obter parâmetros de filtro da URL
    modulo_id = request.GET.get('modulo', '')
    dificuldade = request.GET.get('dificuldade', '')
    
    # Aplicar filtros
    if modulo_id:
        exercicios = exercicios.filter(modulo_id=modulo_id)
    
    if dificuldade:
        exercicios = exercicios.filter(dificuldade=dificuldade)
    
    # Obter todos os módulos para o filtro
    modulos = []
    if TRILHA_EXISTS:
        modulos = Modulo.objects.all().select_related('trilha')
    elif Modulo.objects is not None:
        modulos = Modulo.objects.all()
    
    # Verificar quais exercícios o usuário já resolveu (se autenticado)
    exercicios_resolvidos_ids = []
    pontos_totais = 0
    exercicios_resolvidos_count = 0
    
    if request.user.is_authenticated:
        exercicios_resolvidos_ids = RespostaAluno.objects.filter(
            aluno=request.user,
            status='correto'
        ).values_list('exercicio_id', flat=True)
        
        # Calcular estatísticas
        respostas_corretas = RespostaAluno.objects.filter(
            aluno=request.user,
            status='correto'
        )
        exercicios_resolvidos_count = respostas_corretas.count()
        
        # Calcular pontos totais
        for resposta in respostas_corretas:
            pontos_totais += resposta.exercicio.pontos
    
    context = {
        'exercicios': exercicios,
        'modulos': modulos,
        'selected_modulo': modulo_id,
        'selected_dificuldade': dificuldade,
        'exercicios_resolvidos_ids': list(exercicios_resolvidos_ids),
        'TRILHA_EXISTS': TRILHA_EXISTS,
        'pontos_totais': pontos_totais,
        'exercicios_resolvidos_count': exercicios_resolvidos_count,
    }
    
    return render(request, 'exercicios/index.html', context)

@login_required
def meus_exercicios(request):
    """Mostra exercícios do usuário - resolvidos, em progresso, etc."""
    # Exercícios resolvidos
    exercicios_resolvidos = RespostaAluno.objects.filter(
        aluno=request.user,
        status='correto'
    )
    
    # Tentar usar select_related se Trilha existir
    if TRILHA_EXISTS:
        exercicios_resolvidos = exercicios_resolvidos.select_related('exercicio__modulo__trilha')
    else:
        exercicios_resolvidos = exercicios_resolvidos.select_related('exercicio__modulo')
    
    # Exercícios com tentativas (mas não resolvidos)
    exercicios_tentados = RespostaAluno.objects.filter(
        aluno=request.user,
        status__in=['incorreto', 'parcial']
    )
    
    if TRILHA_EXISTS:
        exercicios_tentados = exercicios_tentados.select_related('exercicio__modulo__trilha')
    else:
        exercicios_tentados = exercicios_tentados.select_related('exercicio__modulo')
    
    # IDs de exercícios já resolvidos
    resolvidos_ids = exercicios_resolvidos.values_list('exercicio_id', flat=True)
    
    # Exercícios recomendados (não resolvidos)
    exercicios_recomendados = Exercicio.objects.exclude(
        id__in=resolvidos_ids
    )
    
    if TRILHA_EXISTS:
        exercicios_recomendados = exercicios_recomendados.select_related('modulo__trilha')
    else:
        exercicios_recomendados = exercicios_recomendados.select_related('modulo')
    
    exercicios_recomendados = exercicios_recomendados.order_by('dificuldade', 'modulo__ordem')[:6]
    
    # Estatísticas
    total_pontos = sum(res.exercicio.pontos for res in exercicios_resolvidos)
    
    context = {
        'exercicios_resolvidos': exercicios_resolvidos,
        'exercicios_tentados': exercicios_tentados,
        'exercicios_recomendados': exercicios_recomendados,
        'total_resolvidos': exercicios_resolvidos.count(),
        'total_pontos': total_pontos,
        'total_tentados': exercicios_tentados.count(),
        'sequencia_atual': 0,  # Adicionado para o template
        'conquistas': 0,  # Adicionado para o template
    }
    
    # CORREÇÃO: O template se chama 'meus.html', não 'meus_exercicios.html'
    return render(request, 'exercicios/meus.html', context)

def detalhe(request, exercicio_id):
    """Mostra detalhes de um exercício"""
    exercicio = get_object_or_404(Exercicio, id=exercicio_id)
    
    # Tentar usar select_related se Trilha existir
    if TRILHA_EXISTS:
        exercicio = get_object_or_404(
            Exercicio.objects.select_related('modulo__trilha'), 
            id=exercicio_id
        )
    
    # Verificar se usuário já resolveu
    resolvido = False
    if request.user.is_authenticated:
        resolvido = RespostaAluno.objects.filter(
            aluno=request.user,
            exercicio=exercicio,
            status='correto'
        ).exists()
    
    context = {
        'exercicio': exercicio,
        'resolvido': resolvido,
    }
    
    return render(request, 'exercicios/detalhe.html', context)

@login_required
def resolver_exercicio(request, exercicio_id):
    """Página para resolver um exercício"""
    exercicio = get_object_or_404(Exercicio, id=exercicio_id)
    
    # Verificar se já existe resposta
    resposta_existente = RespostaAluno.objects.filter(
        aluno=request.user, 
        exercicio=exercicio
    ).first()
    
    if request.method == 'POST':
        resposta_texto = request.POST.get('resposta', '').strip()
        
        if not resposta_texto:
            messages.error(request, 'Digite uma resposta antes de verificar!')
            return render(request, 'exercicios/resolver_exercicio.html', {
                'exercicio': exercicio,
                'resposta_existente': resposta_existente,
            })
        
        # Calcular tempo gasto
        tempo_gasto = 0
        if 'start_time' in request.session:
            tempo_gasto = int(time.time() - request.session['start_time'])
        
        # Criar ou atualizar resposta
        if resposta_existente:
            resposta = resposta_existente
            resposta.tentativas += 1
        else:
            resposta = RespostaAluno(
                aluno=request.user,
                exercicio=exercicio,
                tentativas=1
            )
        
        resposta.resposta = resposta_texto
        resposta.tempo_gasto = tempo_gasto
        
        # Verificar resposta
        resultado = verificar_resposta(resposta_texto, exercicio.resposta_correta)
        
        # Atualizar status e pontos
        resposta.status = resultado['status']
        resposta.pontos_ganhos = resultado['pontos']
        resposta.save()
        
        # Atualizar XP do perfil se correto
        if resultado['status'] == 'correto':
            try:
                perfil = request.user.perfil
                perfil.ganhar_xp(exercicio.pontos)
                perfil.exercicios_resolvidos += 1
                perfil.save()
                messages.success(request, f'? Parabéns! Resposta correta! +{exercicio.pontos} XP')
            except:
                messages.success(request, '? Parabéns! Resposta correta!')
        
        # Redirecionar para página de resultado
        return render(request, 'exercicios/resultado.html', {
            'exercicio': exercicio,
            'resposta': resposta,
            'resultado': resultado
        })
    
    else:
        # GET request - iniciar timer
        request.session['start_time'] = time.time()
        return render(request, 'exercicios/resolver_exercicio.html', {
            'exercicio': exercicio,
            'resposta_existente': resposta_existente,
        })

@login_required
def ver_resultado(request, resposta_id):
    """Visualizar resultado de uma resposta específica"""
    resposta = get_object_or_404(RespostaAluno, id=resposta_id)
    
    # Verificar se o usuário tem permissão para ver esta resposta
    if resposta.aluno != request.user:
        messages.error(request, 'Você não tem permissão para ver este resultado.')
        return redirect('exercicios:index')
    
    return render(request, 'exercicios/resultado.html', {
        'exercicio': resposta.exercicio,
        'resposta': resposta,
    })

# ============ FUNÇÕES AUXILIARES ============

def verificar_resposta(resposta_aluno, resposta_correta):
    """Verifica se a resposta do aluno está correta"""
    resultado = {
        'status': 'incorreto',
        'pontos': 0,
        'feedback': ''
    }
    
    # Converter para minúsculas e remover espaços extras
    resposta = resposta_aluno.strip().lower()
    correta = resposta_correta.strip().lower()
    
    print(f"DEBUG: Resposta aluno: '{resposta}'")
    print(f"DEBUG: Resposta correta: '{correta}'")
    
    # Verificação EXATA
    if resposta == correta:
        resultado['status'] = 'correto'
        resultado['pontos'] = 10
        resultado['feedback'] = 'Resposta perfeitamente correta!'
    else:
        # Verificação PARCIAL
        resposta_palavras = set(resposta.split())
        correta_palavras = set(correta.split())
        
        palavras_comuns = resposta_palavras.intersection(correta_palavras)
        
        if palavras_comuns:
            similaridade = len(palavras_comuns) / max(len(resposta_palavras), len(correta_palavras), 1)
            
            if similaridade > 0.6:
                resultado['status'] = 'parcial'
                resultado['pontos'] = int(10 * similaridade)
                resultado['feedback'] = f'Quase lá! ({similaridade:.0%} similar)'
            else:
                resultado['status'] = 'incorreto'
                resultado['feedback'] = 'Resposta incorreta'
        else:
            resultado['status'] = 'incorreto'
            resultado['feedback'] = 'Resposta incorreta'
    
    print(f"DEBUG: Resultado: {resultado}")
    return resultado
